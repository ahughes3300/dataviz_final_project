---
title: "Mini-Project 02"
output: 
  html_document:
    keep_md: true
    toc: true
    toc_float: true
runtime: shiny
---

```{r message=FALSE,echo=FALSE, warning=FALSE}
library(tidyverse)
library(usmap)
library(ggplot2)
library(broom)
library(lubridate)
library(plotly)
```

```{r message=FALSE,echo=FALSE, warning=FALSE}
source("../scripts/project2_scripts.R")
project2_graph1_map()
```


## Spatial Visualization

1.  What I originally wanted to make was a world map showing the participants origins. However when going through the data it become apparent that there wasn't high number participants represented outside the USA in comparison to inside the USA. So I switched to a USA map and decided to show the participants by state. I further divided the data by Sex to see if there were any visual differences. The steps I took were filtering out the non USA participants and then further dividing them up by sex. I then summed the amount of each per state and created a new data frame to graph the data. Finally I wanted to have something interactive so I decided to use ggplotly so you can see the individual numbers per state.

2.  Looking at this map you can see two things. That the general distribution of male and female participants is very similar as the colors for each state look similar. Also you can see which states have the most participants with Massachusetts having the most. This makes sense because the marathon is hosted in Boston. However whats interesting the second state is California. I think this is interesting because California is so far away from Massachusetts. It's also fun to see that they also had participants from Alaska and Hawaii.

3.  I kept the design simple and used a base red color to make the populations stand out more, and kept it to one color. I made the title left aligned because the viewers eyes tend to view the left. I used a facet style graph to show side by side the male and female participants in a way that was easy to see. I used ggploty to make the map interactive so you can hover over every plot and see the numbers. This draws in the user to use the map.

```{r message=FALSE}
source("../scripts/project2_scripts.R")
Project2_graph2_lm()
```

## Linear Model Line Plot

1.  For the model I originally planed to create a line with geom_smooth and a linear model. I created a linear model then used the linear model data to draw three lines with its associated plot cloud. I also had to convert the time to seconds. I also originally wanted to plot age but it didn't turn out good.

2.  Looking at the data you can see the plot cloud for the three different distances over Finish time. You can see where each distance as a linear model and how it associates with what it predicts where the finish time should be compared to the time at the associated distance. You can see the slopes of the predicted lines. The story you can tell here is you can follow the line and see if you passed a distance at x time your finish them will likely be y time. A runner can use this to target times they need to meet. This is followed for each of the three distances. I had difficulty here adding Age as a component it doesn't seem to create a usable line.

3.  I continued to keep the design simple with bright colors to clash against the white background. I'm a fan of theme_minimal and think it does a good job of decluttering the graph. I added a opacity to the plot points because they were so thick you couldn't see the lines. For each line I added an annotation to identify which line goes to with variable distance.

```{r message=FALSE}
source("../scripts/project2_scripts.R")
Project2_graph3_coef()
```

## Model Visualization Coefficient Plot

1.  For the model I originally planed to create a coefficient plot. I wanted to have more elements originally but I decided to keep it simple and limit it to four plot elements, early in the race, middle of the race and late in the race and finally age. I found that adding more distances was somewhat redundant and complicated the model. The steps I took were running the variables through a linear model, then getting the coefficients and converting the information into to tidy data.

2.  Looking at this map you can see the coefficients and it has a vertical line at zero. Points that are close to the zero don't have much bearing on the outcome. Looking at the plots you can see that 10K is close to the zero line. You can also see that Half race has a value of -1.3 which has a negative influence on the outcome and that 30K is 2.3 positive and has very strong bearing on the overcome of the Finish Time. The Story here is that how you do early in the race has much less effect on your finishing time than how you do later in the race. One last coefficient I threw in here for the graph is Age, you see that Age age has large bearing on your Finish Time. Difficulties I had were the linear model function in R would not take it in time properly I had to change all the times to seconds.

3.  Again I kept design of the graph simple. I have a line in the graph to easily show where zero is. the points are large and easy to see. The theme used here is a minimal theme. I used a SET2 palette to make the colors pop against the white background.

## Interactive Visualization

#### Go to Interactive_Viz.R and select run app to load up interactive bar graph. Below is a screenshot of the app for reference purposes.

![](images/pj2_interactive_screenshot.png){width="600"}

------------------------------------------------------------------------

------------------------------------------------------------------------

**\# Shiny App will load below if compatible otherwise see image above**.

------------------------------------------------------------------------

------------------------------------------------------------------------

```{r, echo = FALSE,runtime: shiny ,out.width =  "100%",out.height="100",message=FALSE}
#
# This is a Shiny web application. You can run the application by clicking
# the 'Run App' button above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#

library(shiny)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(forcats)
library(plotly)


marathon <- read_csv("../data/marathon.csv")
marathon500 <- head(marathon, 300)
colnames(marathon500)[9] ="tenk"
colnames(marathon500)[19] ="OfficalTime"




# Define UI for application that draws a histogram
ui <- fluidPage(

    # Application title
    titlePanel("2017 Boston Marathon Top 300 Participant Data"),

    # Sidebar with a slider input for number of bins 
    sidebarLayout(
        sidebarPanel(
          selectInput(inputId = "Participant_Name",
                      label ="Choose a Participant",
                      "Names"),
          
          htmlOutput("selected_var1"),
          
          selectInput(inputId = "Participant_Name2",
                      label ="Choose a Participant",
                      "Names"),    
          
          htmlOutput("selected_var2"),
          ),

        
        
        
        

        # Show a plot of the generated distribution
        mainPanel(
          
          
          #textOutput("selected_var"),
          
           plotOutput("plot500")
           
        )
    )
)

# Define server logic required to draw a histogram
server <- function(input, output, session) {
  observe({
    updateSelectInput(session,"Participant_Name", choices = marathon500$Name)
  })
  
  observe({
    updateSelectInput(session,"Participant_Name2", choices = marathon500$Name, selected = marathon500$Name[300])
  })
  
  data <- reactive({
    req(input$Participant_Name)
    req(input$Participant_Name2)
    Participant_Name = input$Participant_Name
    Participant_Name2 = input$Participant_Name2
    data4 <- data.frame(Name=c(Participant_Name,Participant_Name,Participant_Name,Participant_Name,Participant_Name,Participant_Name,Participant_Name,Participant_Name,Participant_Name,Participant_Name,Participant_Name,    Participant_Name2,Participant_Name2,Participant_Name2,Participant_Name2,Participant_Name2,Participant_Name2,Participant_Name2,Participant_Name2,Participant_Name2,Participant_Name2,Participant_Name2) ,
                        race=c("5K","10K","15K","20K","Half","25K","30K","35K","40K","Finish","Pace","5K","10K","15K","20K","Half","25K","30K","35K","40K","Finish","Pace") ,  
                        time=c(as.numeric(marathon[which(marathon500$Name == Participant_Name), 8]/60  ),
                               as.numeric(marathon[which(marathon500$Name == Participant_Name), 9] /60 ),
                               as.numeric(marathon[which(marathon500$Name == Participant_Name), 10] /60 ),
                               as.numeric(marathon[which(marathon500$Name == Participant_Name), 11]/60  ),
                               as.numeric(marathon500[which(marathon$Name == Participant_Name), 12]/60  ),
                               as.numeric(marathon500[which(marathon$Name == Participant_Name), 13] /60 ),
                               as.numeric(marathon500[which(marathon$Name == Participant_Name), 14]/60  ),
                               as.numeric(marathon500[which(marathon$Name == Participant_Name), 15]/60  ),
                               as.numeric(marathon500[which(marathon$Name == Participant_Name), 16]/60  ),
                               as.numeric(marathon500[which(marathon$Name == Participant_Name), 18] /60 ),
                               as.numeric(marathon500[which(marathon$Name == Participant_Name), 17] /60 ),
                               as.numeric(marathon[which(marathon500$Name == Participant_Name2), 8] /60 ),
                               as.numeric(marathon[which(marathon500$Name == Participant_Name2), 9]/60),
                               as.numeric(marathon[which(marathon500$Name == Participant_Name2), 10]/60  ),
                               as.numeric(marathon[which(marathon500$Name == Participant_Name2), 11]/60  ),
                               as.numeric(marathon500[which(marathon$Name == Participant_Name2), 12]/60 ),
                               as.numeric(marathon[which(marathon500$Name == Participant_Name2), 13] /60 ),
                               as.numeric(marathon[which(marathon500$Name == Participant_Name2), 14] /60 ),
                               as.numeric(marathon500[which(marathon$Name == Participant_Name2), 15]/60),
                               as.numeric(marathon500[which(marathon$Name == Participant_Name2), 16]/60),
                               as.numeric(marathon500[which(marathon$Name == Participant_Name2), 18]/60),
                               as.numeric(marathon500[which(marathon$Name == Participant_Name2), 17]/60)           
                               )
    ) 
    
      
  })
  
  output$plot500 <- renderPlot({

    
    p<-ggplot(data(), aes(x = fct_inorder(race), y=time, fill=Name)) + 
      geom_col(position = "dodge")+ylim(0,170)+
      xlab("") + ylab("Time in Minutes")+ xlab("Distance")+
      scale_fill_manual(values = c("#EAC115", "#153EEA"))
    p+theme_minimal()
    
  })
  
 
  
  output$selected_var1 <- renderText({
    age1<-marathon[which(marathon500$Name == input$Participant_Name), 3]
    name1 <-input$Participant_Name
    sex1 <- marathon[which(marathon500$Name == input$Participant_Name), 4]
    city1 <- marathon[which(marathon500$Name == input$Participant_Name), 5]
    country1 <- marathon[which(marathon500$Name == input$Participant_Name), 7]
    place1 <- marathon[which(marathon500$Name == input$Participant_Name), 19]
    gender1 <- marathon[which(marathon500$Name == input$Participant_Name), 20]
    HTML(paste0("<h5>","Name: ", name1,'<br>', "Age: ",age1,'<br>',"Sex: ",sex1,'<br>',"City: ",city1,'<br>',"Country: ",country1,'<br>',"Place: ",place1,'<br>'," Place Gender: ",gender1))
  })
    
  output$selected_var2 <- renderText({
    age2<-marathon[which(marathon500$Name == input$Participant_Name2), 3]
    name2 <-input$Participant_Name2
    sex2 <- marathon[which(marathon500$Name == input$Participant_Name2), 4]
    city2 <- marathon[which(marathon500$Name == input$Participant_Name2), 5]
    country2<- marathon[which(marathon500$Name == input$Participant_Name2), 7]
    place2 <- marathon[which(marathon500$Name == input$Participant_Name2), 19]
    gender2 <- marathon[which(marathon500$Name == input$Participant_Name2), 20]
    HTML(paste0("<h5>","Name: ", name2,'<br>', "Age: ",age2,'<br>',"Sex: ",sex2,'<br>',"City: ",city2,'<br>',"Country: ",country2,'<br>',"Place: ",place2,'<br>'," Place Gender: ",gender2))
  })
  
}

# Run the application 
shinyApp(ui = ui, server = server)

```

***Shiny App requires loading up***

**Go to Interactive_Viz.R and select run app to load up Shiny interactive bar graph. Above is a screenshot of the app for reference purposes.**

1.  For my final visualization I wanted to create a shiny application. I decided on displaying the running information for each distance segment on a bar graph and I wanted to make it selectable for each runner in the marathon. I later decided to make a second selectable pull down menu so you can compare two runners information to each other. To prepare the data I had to filter out all the missing or bad data. I also had to cut down the size of my data frame to 300 because large sizes were causing errors.

2.  This map allows an interesting story , you can select two different runners. You can compare their different times at each distance. On the left side you get personal information about the runner such as name, sex, country of origin and age. I used up nearly all the variable information in the dataframe and feel I represented it well in the graph. I had difficulty with the dataframe at full size and had to limit the graph to the top 300 participants. I think I was running out of memory on my computer with a larger dataset, but I am not sure.

3.  The interactive visualization is fairly self explanatory On the left in a clearly marked box you can select between two drop menus. The names for the top 300 runners are in each menu. When you select participant their information is listed below and the graph to right is updated to display each runners times per distance run along with their pace. You can then directly compare two runners. I chose bar graphs because they easily display the information and fill up the available space to make it easy to see. I kept the rest of the graph simple with easy to understand legend and labels and used a minimal theme. I chose the colors yellow and blue because they are the colors of the Boston Marathon and very close to being complimentary colors. I decided on changing from seconds to minutes because people understand minutes in large numbers more than seconds.
